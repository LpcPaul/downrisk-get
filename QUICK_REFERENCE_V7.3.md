# V7.3 快速参考卡片

**目标**: 1分钟快速查找关键流程和公式

---

## 🎯 核心公式

```
VTR (值博率) = 期望收益(1年) ÷ 细分行业σ_down

评级标准 (基于分位数):
  ⭐ 优秀: VTR ≥ 0.28 (Top 30%)
  ✓ 平衡: -0.16 ≤ VTR < 0.28 (30-70%)
  ⚠️ 不佳: VTR < -0.16 (Bottom 30%)
```

---

## 📋 完整执行顺序 (必须记住)

### 📊 Phase 0: 信息收集 (4-6小时)

**Step 0.1: 收集估值数据 (15分钟)**
```bash
python3 scripts/fetch_valuation_data.py
```
- 输出: 当前股价、市值、PE(TTM)、PE(Fwd)
- 数据源: Yahoo Finance
- 时效性: <1小时

**Step 0.2: 搜集财报数据 (2-3小时)**
```yaml
财务数据要求:
  - 2025年H1财报 (最新1-3个月内)
  - 营收、净利润、同比增长率
  - 多业务公司: 分部收入、分部利润
  - 毛利率、EBIT率、ROE等关键指标

未来预期事件 (影响收益预期):
  催化剂事件:
    - 扩产计划: 产能释放时间、预计贡献
    - 技术升级: 新产品/新工艺导入进度
    - 客户突破: 重大客户订单、份额提升
    - 政策利好: 补贴、税收优惠、行业支持
    - 并购整合: 协同效应、业务扩张

  风险事件:
    - 产能过剩: 行业供给过剩、价格战
    - 技术风险: 研发失败、技术路线错误
    - 客户流失: 大客户流失、订单取消
    - 政策风险: 监管变化、补贴退坡
    - 竞争加剧: 新进入者、替代品威胁
    - 原材料风险: 成本大幅上涨、供应短缺

数据来源:
  财务数据:
    - 上市公司公告 (最准确)
    - Wind/Choice数据库
    - 年报/半年报PDF

  预期事件:
    - 券商研报 (近3个月内) ⭐ 核心来源
    - 公司调研纪要/投资者关系活动
    - 行业专家访谈
    - 产业链上下游调研
    - 公司公告 (扩产/并购/技术合作)
```

**Step 0.3: 搜集行业数据 (1-2小时)**
```yaml
行业景气度 (≤3个月):
  - 行业增长率预测
  - 供需格局变化
  - 政策环境
  - 技术趋势

竞争对手分析:
  - 市占率变化
  - 产能扩张计划
  - 价格战风险
```

**Step 0.4: 计算期望收益 (1-2小时)**
```yaml
场景分析框架:
  Bear场景 (20-30%概率):
    - 触发条件: 行业下行/竞争加剧
    - 目标PE: 历史最低PE × 0.8
    - 增长率: 保守假设
    - 场景收益: 通常为负

  Base场景 (40-60%概率):
    - 触发条件: 行业平稳/公司稳健增长
    - 目标PE: 行业平均PE
    - 增长率: 中性假设
    - 场景收益: 5-15%

  Bull场景 (10-30%概率):
    - 触发条件: 行业高景气/技术突破
    - 目标PE: 历史最高PE × 0.9
    - 增长率: 乐观假设
    - 场景收益: 20-50%

期望收益计算:
  E(R) = P_bear × R_bear + P_base × R_base + P_bull × R_bull
  检查: P_bear + P_base + P_bull = 1.0 ✅
```

**Phase 0输出检查**:
```
✓ 所有公司估值数据完整
✓ 财报数据完整 (单业务/多业务分部明确)
✓ 行业数据≤3个月
✓ 所有公司有期望收益
✓ 期望收益在[-50%, +30%]合理区间
```

---

### 🔍 Phase 1: 风险计算 (0.5-1小时)

**Step 1.1: 确定细分行业归属 (30分钟)** ⚠️ **关键步骤 - 必须先执行**

```yaml
单业务公司 (直接映射):
  操作:
    1. 参考 docs/PRECISE_INDUSTRY_SEGMENTATION_V7.md
    2. 根据主营业务确定唯一细分行业
    3. 权重 = 100%

  示例:
    安集科技:
      主营业务: CMP抛光液、光刻胶去除剂
      细分行业: 半导体材料-CMP
      权重: 100%
      ETF代码: 516020.SS

多业务公司 (加权映射):
  操作:
    1. 从财报提取分部利润数据
    2. 计算各业务利润占比
    3. 为每个业务分部确定细分行业
    4. 检查权重之和 = 1.0

  示例:
    紫金矿业:
      铜业务:
        利润: 180亿 (60%)
        细分行业: 铜矿开采
        ETF代码: 562800.SS
      黄金业务:
        利润: 120亿 (40%)
        细分行业: 黄金开采
        ETF代码: 518850.SS
      检查: 60% + 40% = 100% ✅

权重计算优先级:
  1. 财报分部利润披露 (最准确)
  2. 分部收入 × EBIT率 (次优)
  3. 同行对标公司利润结构 (最差)
```

**输出**: `data/company_subindustry_mapping.yml`

```yaml
# 示例格式
安集科技:
  ticker: "688019.SS"
  subdivisions:
    - name: "半导体材料-CMP"
      weight: 1.0
      etf_code: "516020.SS"

紫金矿业:
  ticker: "601899.SS"
  subdivisions:
    - name: "铜矿开采"
      weight: 0.6
      etf_code: "562800.SS"
    - name: "黄金开采"
      weight: 0.4
      etf_code: "518850.SS"
```

---

**Step 1.2: 提取σ_down数据 (15-30分钟)**

```yaml
步骤:
  1. 根据Step 1.1确定的细分行业列表
  2. 检查 data/subindustry_sigma_down.csv
     - 已有: 直接提取 (节省时间)
     - 未有: 执行计算脚本

  3. 如需计算新的σ_down:
     命令: python3 scripts/calculate_subindustry_sigma_down.py
     参数: 细分行业名称, ETF代码
     输出: σ_down值 (10-30%区间)

单业务公司提取:
  安集科技:
    细分行业: 半导体材料-CMP
    ETF代码: 516020.SS
    σ_down: 21.76% (从CSV直接提取)

多业务公司加权:
  紫金矿业:
    铜矿开采 σ_down: 23.02%
    黄金开采 σ_down: 13.06%

    加权σ_down = 0.6 × 23.02% + 0.4 × 13.06%
                = 13.81% + 5.22%
                = 19.04%

    检查: 在[10%, 30%]区间 ✅
```

**Phase 1输出检查**:
```
✓ 所有公司细分行业归属明确
✓ σ_down数据完整 (无缺失)
✓ 多业务公司权重之和 = 1.0
✓ 所有σ_down在[10%, 30%]合理区间
✓ 细分行业名称与PRECISE_INDUSTRY_SEGMENTATION_V7.md一致
```

---

### 🧮 Phase 2: VTR计算 (15-30分钟)

**Step 2.1: 计算VTR**

```yaml
公式:
  VTR = 期望收益(1年) / σ_down

示例计算:
  安集科技:
    期望收益: 14.00%
    σ_down: 21.76%
    VTR = 14.00% / 21.76% = 0.64

  紫金矿业 (多业务):
    期望收益: 8.50%
    加权σ_down: 19.04%
    VTR = 8.50% / 19.04% = 0.45

执行:
  自动: python3 scripts/build_company_subindustry_mapping.py
  手工: 验证至少3家公司计算正确性
```

**Step 2.2: VTR排名**

```yaml
评级标准 (基于分位数):
  ⭐ 优秀: VTR ≥ 0.28 (Top 30%)
  ✓ 平衡: -0.16 ≤ VTR < 0.28 (30-70%)
  ⚠️ 不佳: VTR < -0.16 (Bottom 30%)

输出格式:
  排名 | 公司 | VTR | 期望收益 | σ_down | 细分行业 | 评级
```

**Phase 2输出检查**:
```
✓ VTR排名完整 (所有公司)
✓ 手工验证至少3家VTR计算正确
✓ 多业务公司σ_down为加权值 (非单一值)
✓ 评级分布合理 (避免全部集中)
```

---

### 📈 Phase 3: 投资决策 (2-8小时)

**Step 3.1: 组合配置 (1-2小时)**

```yaml
核心层 (50-60%):
  - VTR Top 3公司
  - 单仓位 8-25%
  - 要求: 优秀评级 + 基本面扎实

成长层 (25-35%):
  - VTR Top 4-10公司
  - 单仓位 5-10%
  - 要求: 优秀/平衡评级 + 增长确定性

均衡层 (5-10%):
  - VTR Top 11-15公司
  - 单仓位 2-5%
  - 要求: 平衡评级 + 防御性

现金 (3-5%):
  - 灵活调仓缓冲
```

**Step 3.2: 风控规则 (30分钟)**

```yaml
行业敞口限制:
  - 单一细分行业 ≤ 40%
  - 半导体合计 ≤ 50%
  - TMT合计 ≤ 30%

个股限制:
  - 单一公司 ≤ 25%
  - Top 3合计 ≤ 60%

止损规则:
  - 单一公司最大亏损 -15%
  - 组合最大回撤 -20%
```

**Step 3.3: 生成报告 (30分钟-6小时)**

```yaml
简版报告 (30分钟):
  - 执行摘要
  - Top 10排名表
  - 投资组合建议
  - 风险提示

详版报告 (2-6小时):
  + 每家公司详细分析 (1-2页)
  + 场景分析 (Bear/Base/Bull)
  + 行业深度分析
  + 历史回测 (可选)
```

**Phase 3输出检查**:
```
✓ 组合配置合理 (核心+成长+均衡)
✓ 行业敞口未超限
✓ 个股仓位未超限
✓ 风控规则设置完整
✓ 报告结构清晰完整
```

---

### ⏱️ 完整执行时间估算

| 场景 | Phase 0 | Phase 1 | Phase 2 | Phase 3 | 合计 |
|------|---------|---------|---------|---------|------|
| **首次执行 (23家)** | 4-6h | 1h | 0.5h | 2-8h | 8-12h |
| **新增公司 (9家)** | 3-4h | 0.5h | 0.25h | 0.5h | 4-5h |
| **季度更新 (23家)** | 2-3h | 0.5h | 0.25h | 1-2h | 4-6h |
| **紧急更新 (单家)** | 0.5h | 0.1h | 0.05h | 0.2h | 1h |

---

### ✅ 正确执行顺序总结

```
Phase 0: 信息收集
  ├─ Step 0.1: 收集估值数据 (15分钟)
  ├─ Step 0.2: 搜集财报数据 (2-3小时)
  ├─ Step 0.3: 搜集行业数据 (1-2小时)
  └─ Step 0.4: 计算期望收益 (1-2小时)
        ↓
Phase 1: 风险计算
  ├─ Step 1.1: 确定细分行业归属 (30分钟) ⚠️ 必须先执行!
  └─ Step 1.2: 提取σ_down数据 (15-30分钟)
        ↓
Phase 2: VTR计算
  ├─ Step 2.1: 计算VTR (15分钟)
  └─ Step 2.2: VTR排名 (15分钟)
        ↓
Phase 3: 投资决策
  ├─ Step 3.1: 组合配置 (1-2小时)
  ├─ Step 3.2: 风控规则 (30分钟)
  └─ Step 3.3: 生成报告 (0.5-6小时)
```

### ❌ 错误顺序对比

```
❌ 错误:
Phase 0 → 提取σ_down (不知道需要哪些) → 确定细分行业 (发现缺数据) → 重新提取

✅ 正确:
Phase 0 → 确定细分行业 (先知道需要哪些) → 提取σ_down (针对性提取) → 计算VTR
```

---

## 📐 多业务公司处理

### 利润权重计算

```python
# 优先级1: 财报分部利润 (最准确)
紫金矿业:
  铜业务利润: 180亿 (60%)
  黄金业务利润: 120亿 (40%)

# 优先级2: 分部收入 × EBIT率 (次优)
特变电工:
  输变电收入: 600亿 × 10% = 60亿 (60%)
  多晶硅收入: 400亿 × 10% = 40亿 (40%)

# 检查: Σ权重 = 1.0 ✅
```

### 加权σ_down计算

```python
紫金矿业:
  铜矿开采: σ_down = 23.02%
  黄金开采: σ_down = 13.06%

  加权σ_down = 0.6 × 23.02% + 0.4 × 13.06%
              = 13.81% + 5.22%
              = 19.04%
```



---

## 💡 场景分析模板

```yaml
公司: [公司名称]
细分行业: [行业]

Bear场景 (%概率):
  触发条件: [具体条件]
  目标PE: [倍数]
  增长率: [%]
  场景收益: [%]

Base场景 (%概率):
  触发条件: [具体条件]
  目标PE: [倍数]
  增长率: [%]
  场景收益: [%]

Bull场景 (%概率):
  触发条件: [具体条件]
  目标PE: [倍数]
  增长率: [%]
  场景收益: [%]

期望收益 = Bear概率×Bear收益 + Base概率×Base收益 + Bull概率×Bull收益
         = X%

VTR = X% / σ_down
```

---

## ⚠️ 常见错误

### 1. 粒度不匹配

```
❌ 错误:
  光迅科技:
    收益分析用: "光通信模块" (800G/1.6T)
    风险分母用: TMT大行业 σ_down = 23.76%

✅ 正确:
  光迅科技:
    收益分析用: "光通信模块"
    风险分母用: 光通信ETF σ_down = 25.43%
```

### 2. 多业务公司忽略权重

```
❌ 错误:
  紫金矿业 σ_down = 铜(23.02%) (忽略黄金)

✅ 正确:
  紫金矿业 σ_down = 0.6×铜(23.02%) + 0.4×黄金(13.06%) = 19.04%
```

### 3. VTR分母叠加

```
❌ 错误:
  VTR = 期望收益 / Scheme C复合风险
  VTR = 期望收益 / (σ_down + β + Frag)

✅ 正确:
  VTR = 期望收益 / 纯σ_down
```

---

## 📁 关键文件路径

```
项目根目录/
├── COMPLETE_WORKFLOW_V7.3_UPDATED.md  ← 完整执行流程
├── docs/EXECUTION_FLOWCHART_V7.3.md   ← 可视化流程图
├── V7.3_COMPLETE_RANKING_23COMPANIES_2025Q3.md  ← 完整排名报告
├── CHANGELOG_V7.3.1.md                ← 更新日志
├── QUICK_REFERENCE_V7.3.md            ← 本文档
│
├── data/
│   ├── subindustry_sigma_down.csv     ← 细分行业σ_down
│   ├── company_subindustry_vtr.csv    ← VTR排名
│   └── company_subindustry_mapping.yml ← 公司-行业映射
│
├── scripts/
│   ├── calculate_subindustry_sigma_down.py  ← 计算σ_down
│   ├── build_company_subindustry_mapping.py ← 计算VTR
│   └── fetch_valuation_data.py              ← 获取估值数据
│
└── docs/
    ├── PRECISE_INDUSTRY_SEGMENTATION_V7.md  ← 细分行业定义
    └── V7.3_SUBINDUSTRY_SIGMA_ANALYSIS.md   ← σ_down分析报告
```

---

## 🚀 快速命令

```bash
# 1. 计算细分行业σ_down
python3 scripts/calculate_subindustry_sigma_down.py

# 2. 计算VTR并排名
python3 scripts/build_company_subindustry_mapping.py

# 3. 获取估值数据
python3 scripts/fetch_valuation_data.py

# 4. 查看VTR排名
cat data/company_subindustry_vtr.csv

# 5. 查看σ_down数据
cat data/subindustry_sigma_down.csv
```





---

## 🔧 数据质量检查

```
Phase 0完成后:
  ✓ 财报数据完整 (所有公司)
  ✓ 细分行业分析完整
  ✓ 所有公司有期望收益
  ✓ 期望收益在[-50%, +30%]区间

Phase 1完成后:
  ✓ 细分行业归属明确
  ✓ σ_down数据完整
  ✓ 多业务公司权重之和=1.0
  ✓ σ_down在[10%, 30%]区间

Phase 2完成后:
  ✓ VTR排名完整
  ✓ 手工验证至少3家VTR
  ✓ 多业务公司σ_down为加权值

Phase 3完成后:
  ✓ 组合配置合理
  ✓ 行业敞口未超限
  ✓ 风控规则设置
```

---

## 📞 问题排查

| 问题 | 可能原因 | 解决方案 |
|------|---------|---------|
| σ_down数据缺失 | 细分行业未计算 | 执行calculate_subindustry_sigma_down.py |
| VTR计算错误 | 公式错误 | VTR = 期望收益 / σ_down (不要叠加) |
| 多业务公司σ_down错误 | 未加权 | 检查权重之和=1.0，重新计算加权σ_down |
| 期望收益异常 | 场景分析错误 | 检查Bear/Base/Bull概率之和=1.0 |
| 细分行业名称不一致 | 拼写错误 | 参考PRECISE_INDUSTRY_SEGMENTATION_V7.md |

---

## 🎯 VTR阈值 

```
P30 (Top 30%): VTR ≥ 0.28
  ⭐ 优秀: 12家 (52.2%)

P70 (30-70%): -0.16 ≤ VTR < 0.28
  ✓ 平衡: 7家 (30.4%)

Bottom 30%: VTR < -0.16
  ⚠️ 不佳: 4家 (17.4%)
```

---

## 📚 延伸阅读

### 方法论
- `docs/V7.3_SUBINDUSTRY_SIGMA_ANALYSIS.md` - 细分行业σ_down完整分析
- `docs/PRECISE_INDUSTRY_SEGMENTATION_V7.md` - 精确细分行业定义
- `docs/SCENARIO_ANALYSIS_FRAMEWORK.md` - 场景分析框架

### 执行指南
- `COMPLETE_WORKFLOW_V7.3_UPDATED.md` - 端到端完整流程
- `docs/EXECUTION_FLOWCHART_V7.3.md` - 可视化流程图
- `EXECUTION_GUIDE_V7.3.md` - VTR计算快速指南

### 数据报告
- `V7.3_COMPLETE_RANKING_23COMPANIES_2025Q3.md` - 完整排名报告
- `CHANGELOG_V7.3.1.md` - 更新日志

---

**快速参考版本**: V7.3
**最后更新**: 2025-10-08
**维护者**: @LpcPaul

---

**🌟 提示**: 打印本文档，随时查阅关键公式和流程！
